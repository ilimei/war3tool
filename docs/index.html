<html>
<head>
    <style>
        .noselect {
            user-select: none;
        }
        .textEditor {
            border-radius: 0;
            padding: 4px;
            background-color: rgb(26, 30, 31);
            color: #fff;
            outline: none;
            overflow: auto;
            border: 1px solid #ccc;
            height: 200px;
        }
        .result {
            border: 1px solid #ccc;
            padding: 4px;
        }
    </style>
    <title>war3文字颜色</title>
</head>
<body>
    <h1>war3文字颜色</h1>
    <div id="textable" class="textEditor" contenteditable="true">渐变的文字</div>
    <div class="noselect">
        <input id="normalColorInput" type="color" id="head" name="head" value="#ffffff">
        <button id="normal">确定</button>
    </div>
    <div class="noselect">
        start:<input id="startColorInput" type="color" id="head" name="head" value="#ff0000">
        end:<input id="endColorInput" type="color" id="head" name="head" value="#ffff00">
        <button id="flow">确定</button>
    </div>
    <div class="result">
        <pre id="result">渐变的文字</pre>
    </div>
    <script>
        var normalColor = {
            r: 255,
            g: 255,
            b: 255
        }

        var startColor = {
            r: 255,
            g: 0,
            b: 0
        };
        var stopColor = {
            r: 255,
            g: 255,
            b: 0
        };

        function toResult() {
            result.innerHTML = textable.innerHTML.replace(/<div>/g, '\n')
                .replace(/<\/div>/g, '')
                .replace(/<\/font>/g, '|r')
                .replace(/<font color="#([a-f\d]+)">/g, (t, $1) => `|cff${$1.toUpperCase()}`)
                .replace(/\|r\|c/g, "\|c")
        }

        textable.oninput = function (e) {
            e.target.height = e.target.scrollHeight + "px";
            toResult();
        }

        normalColorInput.onchange = function (e) {
            var color = e.target.value;
            normalColor.r = parseInt(color.slice(1).slice(0, 2), 16);
            normalColor.g = parseInt(color.slice(1).slice(2, 4), 16);
            normalColor.b = parseInt(color.slice(1).slice(4, 6), 16);
        }

        startColorInput.onchange = function (e) {
            var color = e.target.value;
            startColor.r = parseInt(color.slice(1).slice(0, 2), 16);
            startColor.g = parseInt(color.slice(1).slice(2, 4), 16);
            startColor.b = parseInt(color.slice(1).slice(4, 6), 16);
        }

        endColorInput.onchange = function (e) {
            var color = e.target.value;
            stopColor.r = parseInt(color.slice(1).slice(0, 2), 16);
            stopColor.g = parseInt(color.slice(1).slice(2, 4), 16);
            stopColor.b = parseInt(color.slice(1).slice(4, 6), 16);
        }

        flow.onclick = function (e) {
            var sel = document.getSelection();
            var rng = sel.getRangeAt(0);
            var text = rng.toString();
            const txtArr = text.split(/\s*/);
            console.info(text, txtArr);
            if (txtArr.length > 1) {
                document.execCommand('delete'); // with rgba
                var dhr = {
                    r: (stopColor.r - startColor.r) / (txtArr.length - 1),
                    g: (stopColor.g - startColor.g) / (txtArr.length - 1),
                    b: (stopColor.b - startColor.b) / (txtArr.length - 1),
                }
                document.execCommand('insertHTML', false, txtArr.map((v, index) => {
                    var rgb = {
                        r: startColor.r + dhr.r * index,
                        g: (startColor.g + dhr.g * index) | 0,
                        b: (startColor.b + dhr.b * index) | 0,
                    }
                    return `<font color="#${rgb.r.toString(16).padStart(2, '0') + rgb.g.toString(16).padStart(2, '0') + rgb.b.toString(16).padStart(2, '0')}">${v}</font>`
                }).join(""));
            } else if (txtArr.length === 1) {
                document.execCommand('foreColor', false,
                    `rgb(${startColor.r},${startColor.g},${startColor.b})`); // with rgba
            }
        }

        normal.onclick = function (e) {
            document.execCommand('foreColor', false,
                `rgb(${normalColor.r},${normalColor.g},${normalColor.b})`); // with rgba
            toResult();
        }
    </script>
</body>
</html>